# Flask AI 服务与 Spring Boot 集成指南

## 对接流程图

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   前端      │         │ Spring Boot  │         │   Flask     │
│   (Vue3)    │         │   (业务服务)  │         │  (AI 服务)  │
└──────┬──────┘         └──────┬───────┘         └──────┬──────┘
       │                       │                        │
       │  1. 上传视频           │                        │
       ├──────────────────────>│                        │
       │                       │                        │
       │  2. 创建任务           │                        │
       ├──────────────────────>│                        │
       │                       │  3. 调用 AI 服务        │
       │                       ├───────────────────────>│
       │                       │  POST /api/generate    │
       │                       │  {taskId, videoUrl}    │
       │                       │                        │
       │  4. 返回任务已创建     │<───────────────────────┤
       │<──────────────────────┤  202 Accepted          │
       │                       │                        │
       │  5. 轮询任务状态       │                        │
       ├──────────────────────>│                        │
       │  GET /api/tasks/{id}  │                        │
       │                       │         6. 处理视频...  │
       │                       │         (异步后台处理)  │
       │                       │                   ↓    │
       │                       │  7. 处理完成，回调       │
       │                       │<───────────────────────┤
       │                       │  POST /api/internal/   │
       │                       │       tasks/callback   │
       │                       │  {taskId, mermaidCode} │
       │                       │                        │
       │  8. 获取思维导图       │                        │
       ├──────────────────────>│                        │
       │<──────────────────────┤                        │
       │  {mermaidCode, nodes} │                        │
       │                       │                        │
```

## 接口对接详情

### 1. Spring Boot 调用 Flask

**接口**: `POST http://localhost:10020/api/generate`

**请求参数**:

```json
{
  "taskId": "task-uuid-001",
  "videoUrl": "http://localhost:10010/files/video-uuid.mp4",
  "callbackUrl": "http://localhost:10010/api/internal/tasks/callback"
}
```

**Flask 响应** (立即返回):

```json
{
  "code": 202,
  "message": "任务已接收，正在处理中",
  "data": {
    "taskId": "task-uuid-001",
    "status": "processing"
  }
}
```

### 2. Flask 回调 Spring Boot

**接口**: `POST http://localhost:10010/api/internal/tasks/callback`

**成功时的回调参数**:

```json
{
  "taskId": "task-uuid-001",
  "status": "success",
  "mermaidCode": "graph TD\n    A[节点1] --> B[节点2]",
  "summary": "这是一段视频概要...",
  "originalOutput": "{\"nodes\": [...]}"
}
```

**失败时的回调参数**:

```json
{
  "taskId": "task-uuid-001",
  "status": "failed",
  "errorMessage": "处理失败: 视频格式不支持"
}
```

## 配置说明

### Spring Boot 配置

在 `services/business-service/src/main/resources/application.yml` 中：

```yaml
# AI 服务配置（Flask 服务地址）
ai:
  service:
    url: http://localhost:10020
```

### Flask 配置

编辑 `ai/.env` 文件（从 `.env.example` 复制）：

```env
# Spring Boot 服务地址
SPRING_BOOT_URL=http://localhost:10010

# 服务端口
PORT=10020
```

## 测试对接

### 1. 测试 Flask 服务

```bash
# 测试健康检查
curl http://localhost:10020/health

# 测试生成接口
curl -X POST http://localhost:10020/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "test-001",
    "videoUrl": "http://example.com/video.mp4",
    "callbackUrl": "http://localhost:10010/api/internal/tasks/callback"
  }'
```

### 2. 完整流程测试

使用 Python 测试脚本：

```bash
cd ai
python test_api.py
```

### 3. 通过前端测试

1. 登录系统获取 Token
2. 上传视频文件
3. 创建任务
4. 查询任务状态
5. 获取生成的思维导图

## 常见问题

### 问题 1: 回调失败

**原因**: Spring Boot 地址不正确或防火墙拦截

**解决**:

1. 检查 Spring Boot 是否在 10010 端口运行
2. 检查回调 URL 是否正确
3. 查看 Flask 日志确认错误信息

### 问题 2: 跨域问题

**原因**: Flask 未配置 CORS

**解决**: Flask 已包含 `flask-cors`，如需启用：

```python
from flask_cors import CORS
CORS(app) 
```

## 性能优化

1. **使用异步任务队列** (Celery + Redis)
2. **增加工作进程数** (Gunicorn -w 参数)
3. **添加请求限流** (Flask-Limiter)
4. **使用缓存** (Redis)
5. **文件存储优化** (对象存储如阿里云 OSS)
